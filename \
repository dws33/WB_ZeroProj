# –ü—É—Ç–∏ –∫ Go-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º
KAFKAFILLER = /cmd/eventhandler/testhelpers/kafkafiller/main.go
EVENTHANDLER = /cmd/eventhandler/main.go
HTTPSERVER = /cmd/httpserver/main.go
WEBSITE = /cmd/website/main.go

# Docker Compose
DOCKER_COMPOSE = docker-compose.yml

# –ü–æ–¥–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ .env
include .env
export

# –ì–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å
all: up-zookeeper up-kafka up-postgres run-kafkafiller run-eventhandler run-httpserver run-website

# –ó–∞–ø—É—Å–∫ Zookeeper –∏ –æ–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
up-zookeeper:
	@echo "üöÄ –ó–∞–ø—É—Å–∫ Zookeeper..."
	docker compose -f $(DOCKER_COMPOSE) up -d zookeeper
	@echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ Zookeeper (–ø–æ—Ä—Ç 2181)..."
	@until nc -z localhost 2181; do sleep 1; done
	@echo "‚úÖ Zookeeper –≥–æ—Ç–æ–≤."

# –ó–∞–ø—É—Å–∫ Kafka –∏ –æ–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
up-kafka: up-zookeeper
	@echo "üöÄ –ó–∞–ø—É—Å–∫ Kafka..."
	docker compose -f $(DOCKER_COMPOSE) up -d kafka
	@echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ Kafka (–ø–æ—Ä—Ç 9092)..."
	@until nc -z localhost 9092; do sleep 1; done
	@echo "‚úÖ Kafka –≥–æ—Ç–æ–≤."

# –ó–∞–ø—É—Å–∫ PostgreSQL –∏ –æ–∂–∏–¥–∞–Ω–∏–µ
up-postgres:
	@echo "üöÄ –ó–∞–ø—É—Å–∫ PostgreSQL..."
	docker compose -f $(DOCKER_COMPOSE) up -d postgres
	@echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ PostgreSQL..."
	@until docker compose logs postgres | grep "database system is ready to accept connections"; do sleep 1; done
	@echo "‚úÖ PostgreSQL –≥–æ—Ç–æ–≤."

# –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π Go
run-kafkafiller:
	@echo "‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫ kafkafiller..."
	go run $(KAFKAFILLER)

run-eventhandler:
	@echo "‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫ eventhandler..."
	go run $(EVENTHANDLER)

run-httpserver:
	@echo "‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫ httpserver..."
	go run $(HTTPSERVER)

run-website:
	@echo "‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫ website..."
	go run $(WEBSITE)

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
down:
	docker compose -f $(DOCKER_COMPOSE) down

